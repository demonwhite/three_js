function map_range(e,a,t,o,n){return o+(n-o)*(e-a)/(t-a)}function initGUI(){gui=new dat.GUI({autoPlace:!1});var e=document.getElementById("my-gui-container");e.appendChild(gui.domElement);var a=gui.addFolder("Test");a.add(soundChannel.full,"position",soundChannel.full.min,soundChannel.full.max).step(1),a.add(soundChannel.full,"threshold",0,100).name("Threshold"),a.open();var t=gui.addFolder("Vocal");t.add(soundChannel.vocal,"position",soundChannel.vocal.min,soundChannel.vocal.max).step(1),t.open();var o=gui.addFolder("Bass");o.add(soundChannel.bass,"position",soundChannel.bass.min,soundChannel.bass.max).step(1),o.open();var n=gui.addFolder("High");n.add(soundChannel.high,"position",soundChannel.high.min,soundChannel.high.max).step(1),n.open();var r=gui.addFolder("Low");r.add(soundChannel.low,"position",soundChannel.low.min,soundChannel.low.max).step(1),r.open();var i=gui.addFolder("Camera");i.add(cameraControls,"fov",30,120).name("FOV"),i.add(cameraControls,"zoom",2,5).name("Zoom"),i.add(cameraControls,"rotateSpeed",0,.1).name("Rotation"),i.add(cameraControls,"actionFov",35,120).name("Action FOV"),i.add(cameraControls,"actionTarget",0,FFT_SIZE).name("Target").step(1),i.open(),console.log("GUI initialized")}function init(){scene=new THREE.Scene,actionCam=new THREE.PerspectiveCamera(80,window.innerWidth/window.innerHeight,1e-4,500),actionCam.position.set(0,0,0),cameraHelper=new THREE.CameraHelper(actionCam),camera=new THREE.PerspectiveCamera(cameraControls.fov,window.innerWidth/window.innerHeight,cameraControls.near,cameraControls.far),camera.position.set(cameraControls.x,cameraControls.y,cameraControls.z),light=new THREE.SpotLight(16777215,.3),light.position.copy(camera.position),light.target.position.set(0,0,0),light.castShadow=!0,scene.add(light),hsLight=new THREE.HemisphereLight(16777215,526368,1),scene.add(hsLight);var e=new THREE.DodecahedronGeometry(.33*particles_radius,0),a=new THREE.MeshPhongMaterial({color:16723759,shading:THREE.FlatShading,shininess:0});core=new THREE.Mesh(e,a),scene.add(core);var t=new THREE.IcosahedronGeometry(.97*particles_radius,1),a=new THREE.MeshPhongMaterial({color:16777215,transparent:!0,opacity:.5,shading:THREE.FlatShading,shininess:0});earth=new THREE.Mesh(t,a),earth.receiveShadow=!0,earth.castShadow=!0,scene.add(earth);var o=FFT_SIZE,n=2*Math.PI;particles_geo=new THREE.BufferGeometry;var r=new Float32Array(3*o),i=new Float32Array(3*o),s=new Float32Array(o);particle_positions=[];for(var l=0;o>l;l++){var d=new KVec3(particles_radius,l);d.toArray(r,3*l),particle_positions.push(d);var c=new THREE.Color;l%15==0?c.setHSL(.9,.1,.3):c.setHSL(.01+.1*(l/o),1,.5),c.toArray(i,3*l),s[l]=100}particles_geo.addAttribute("position",new THREE.BufferAttribute(r,3)),particles_geo.addAttribute("aColor",new THREE.BufferAttribute(i,3)),particles_geo.addAttribute("size",new THREE.BufferAttribute(s,1)),line_position=new Float32Array(FFT_SIZE*FFT_SIZE*3),line_color=new Float32Array(FFT_SIZE*FFT_SIZE*3),line_geometry=new THREE.BufferGeometry,line_geometry.addAttribute("position",new THREE.BufferAttribute(line_position,3).setDynamic(!0)),line_geometry.addAttribute("color",new THREE.BufferAttribute(line_color,3).setDynamic(!0)),particles_geo.setDrawRange(0,0);var p=new THREE.PointsMaterial({color:0,size:0,visible:!1});particle=new THREE.Points(particles_geo,p),scene.add(particle),line_material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,blending:THREE.SubtractiveBlending,transparent:!0}),line_mesh=new THREE.LineSegments(line_geometry,line_material),line_mesh.geometry.setDrawRange(0,0),scene.add(line_mesh),laser_position=new Float32Array(2*numLaser*3),laser_color=new Float32Array(2*numLaser*3),laser_geometry=new THREE.BufferGeometry,laser_geometry.addAttribute("position",new THREE.BufferAttribute(laser_position,3).setDynamic(!0)),laser_geometry.addAttribute("color",new THREE.BufferAttribute(laser_color,3).setDynamic(!0)),laser_material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),laser_mesh=new THREE.LineSegments(laser_geometry,laser_material),scene.add(laser_mesh);var m=document.createElement("div");m.style.position="absolute",m.style.top="10px",m.style.width="100%",m.style.textAlign="center",m.style.color="#fff",m.style.link="#f80",m.innerHTML='<a href="http://threejs.org" target="_blank">three.js</a> kent&rsquo;s test',document.body.appendChild(m),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setClearColor(14274768),renderer.autoClear=!0,renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.domElement.id="canvas",document.body.appendChild(renderer.domElement),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.gammaInput=!0,renderer.gammaOutput=!0,stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",stats.domElement.style.right="0px",m.appendChild(stats.domElement),controls=new THREE.TrackballControls(camera,renderer.domElement),controls.minDistance=200,controls.maxDistance=700,dummy=new THREE.Vector3(1,1,1),dummy.x=particle_positions[cameraControls.actionTarget].x,dummy.y=particle_positions[cameraControls.actionTarget].y,dummy.z=particle_positions[cameraControls.actionTarget].z,ballGroup=new THREE.Object3D;for(var u=new THREE.SphereBufferGeometry(1,25,25),h=new THREE.MeshLambertMaterial({emissive:263172,color:657930,reflectivity:.4}),f=new THREE.Mesh(u,h),l=0;FFT_SIZE>l;l++){var f=new THREE.Mesh(u,h);f.position.x=particle_positions[l].x,f.position.y=particle_positions[l].y,f.position.z=particle_positions[l].z,f.castShadow=!0,ballGroup.add(f)}particle.add(ballGroup),window.addEventListener("resize",onWindowResize,!1)}function all_rotation(e){earth.rotation.y+=3*e,earth.rotation.x+=3*e,earth.rotation.z-=3*e,particle.rotation.y+=e,particle.rotation.x+=e,line_mesh.rotation.y+=e,line_mesh.rotation.x+=e,core.rotation.y-=2*e,core.rotation.x+=3*e}function render(){stats.begin(),all_rotation(cameraControls.rotateSpeed),checkZoom(),updateGUI(),sc.isPlaying&&(updateFFT(),parseFFT()),updatePosition(),checkDistance(),updateLaser(),updateBalls(),updateCore(),updateDummy(particle_positions[cameraControls.actionTarget]),updateFOV(),controls.update(),light.position.copy(camera.position),light.position.y+=100,light.position.x+=50,runningCamera?renderer.render(scene,actionCam):renderer.render(scene,camera),stats.end(),requestAnimationFrame(render)}function updateFFT(){sc.updateFFT(),fftList=[],fftList=sc.fft;for(i in fftList){var e=fftList[i];fftList[i]=map_range(e,0,255,0,100)}}function updateDummy(e){e.distanceTo(dummy)>2*e.FIELD&&dummy.lerp(e,.01),actionCam.position.set(dummy.x,dummy.y,dummy.z),actionCam.fov=cameraControls.actionFov,actionCam.lookAt(e),actionCam.updateProjectionMatrix()}function updateBalls(){for(var e=ballGroup.children,a=0;a<e.length;a++){var t=e[a],o=particle_positions[a];t.position.set(o.x,o.y,o.z);var n=fftList[a],r=t.scale.x,i=90;r+=n>=i?.1*(n/3-r):.1*(1-r),t.scale.set(r,r,r)}}function updateGUI(){for(var e in gui.__folders){var a=gui.__folders[e];for(var t in a.__controllers)a.__controllers[t].updateDisplay()}fftList&&(soundChannel.vocal.value=fftList[Math.floor(soundChannel.vocal.position)]),camera.near=cameraControls.near,camera.far=cameraControls.far,camera.updateProjectionMatrix()}function updateFakeFFT(){for(var e=Date.now(),a=0;a<fakeFFT.length;a++){var t=noise.simplex2(a,e);fakeFFT[a]=t/2}fakeFFT.reverse()}function parseFFT(){for(var e=0;e<fftList.length;e++);}function checkZoom(){}function checkDistance(){for(var e,a,t=40,o=3,n=0,r=0,i=0,s=0;FFT_SIZE>s;s++)particle_positions[s].numConnected=0;for(var l=0;FFT_SIZE>l;l++)if(e=particle_positions[l],!(e.numConnected>=o))for(var d=l+1;FFT_SIZE>d;d++){a=particle_positions[d];var c=e.x-a.x,p=e.y-a.y,m=e.z-a.z,u=Math.sqrt(c*c+p*p+m*m);if(!(a.numConnected>=o)&&t>u){e.numConnected++,a.numConnected++,line_position[n++]=e.x,line_position[n++]=e.y,line_position[n++]=e.z,line_position[n++]=a.x,line_position[n++]=a.y,line_position[n++]=a.z;var h=1-u/t;line_color[r++]=h,line_color[r++]=h,line_color[r++]=h,line_color[r++]=h,line_color[r++]=h,line_color[r++]=h,i++}}line_mesh.geometry.setDrawRange(0,2*i),line_mesh.geometry.attributes.position.needsUpdate=!0,line_mesh.geometry.attributes.color.needsUpdate=!0}function updateLaser(){for(var e,a,t=0;numLaser>t;t++){e=particle_positions[t],a=e.clone(),a.multiplyScalar(1e3);var o=6*t;laser_position[o]=0,laser_position[o+1]=0,laser_position[o+2]=0,laser_position[o+3]=a.x,laser_position[o+4]=a.y,laser_position[o+5]=a.z,laser_color[o]=map_range(t,0,numLaser,0,.5),laser_color[o+1]=0,laser_color[o+2]=map_range(t,0,5*numLaser,0,1)}laser_mesh.geometry.setDrawRange(0,3*numLaser),laser_mesh.geometry.attributes.position.needsUpdate=!0}function updatePosition(){var e=particle.geometry.attributes;for(p in particle_positions){particle_positions[p].movePos();var a,t;a=particle_positions[p];for(s in particle_positions)t=particle_positions[s],a.ID!=t.ID&&a.pushPos(t);e.position.array[3*p]=particle_positions[p].x,e.position.array[3*p+1]=particle_positions[p].y,e.position.array[3*p+2]=particle_positions[p].z,255===fftList[p]&&popCloud===!0&&_createBox(particle_positions[p].x,particle_positions[p].y,particle_positions[p].z)}e.position.needsUpdate=!0}function updateCore(){var e=fftList[soundChannel.bass.position];if(e>=soundChannel.bass.threshold){e*=.005;var a=.05*(1-e-core.scale.x);core.scale.x+=a,core.scale.y+=a,core.scale.z+=a}else{var a=.05*(1-core.scale.x);core.scale.x+=a,core.scale.y+=a,core.scale.z+=a}}function updateFOV(){var e=cameraControls.fov-20,a=cameraControls.fov,t=fftList[soundChannel.high.position];if(t>=soundChannel.high.threshold){var o=map_range(t,soundChannel.high.threshold,100,e,a),n=.05*(o-camera.fov);camera.fov+=n}else{var n=.1*(cameraControls.fov-camera.fov);camera.fov+=n}}function _createBox(e,a,t){var o=10,n=new THREE.BoxGeometry(o,o,o);n.translate(e,a,t);var r=new THREE.MeshDepthMaterial({wireframe:!1}),i=new THREE.Mesh(n,r);scene.add(i)}function updateAudioData(){}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,actionCam.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),actionCam.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function dealWithKeyboard(e){switch(console.log(e.keyCode),e.keyCode){case 73:console.log("key I pressed"),information=!information;break;case 32:runningCamera=!runningCamera,console.log("switch camera: "+runningCamera);break;case 219:sc.fastBackward(1);break;case 221:sc.fastForward(1);break;case 220:sc.resetPlaybackRate();break;default:console.log("no key action taken, pressed: "+e.keyCode)}information?(gui.domElement.hidden=!1,stats.domElement.hidden=!1,document.getElementById("progressBar").style.display="block",document.getElementById("progressBar-indivisual").style.display="block"):(gui.domElement.hidden=!0,stats.domElement.hidden=!0,document.getElementById("progressBar").style.display="none",document.getElementById("progressBar-indivisual").style.display="none")}function testClick(){console.log("Document Clicked")}function debug(){}function updateShader(){var e=.01*Date.now()}var sc=new SoundObject(1024),fileLoader=new FileLoader,files=[{name:"music",path:"sounds/day.mp3",type:"arraybuffer",time:400}];fileLoader.start(files);var allFilesLoaded=new Event("fire");document.addEventListener("fire",function(e){console.log("FIRRRRRRRRRRE!!!!!!"),document.getElementById("audio-play").classList.add("avl"),sc.init(fileLoader.content.music)}),document.getElementById("audio-play").addEventListener("click",function(){sc.play()}),document.getElementById("audio-pause").addEventListener("click",function(){sc.pause()});var camera,actionCam,scene,renderer,controls,stats,fftList,light,hsLight,cameraHelper,core,earth,dummy,FFT_SIZE=256,fftList=new Array(FFT_SIZE),particle,particles_geo,particle_met,pt_uniforms,particles_radius=256,fftBands=[],nFFTBands=5,particle_positions,fakeFFT,line_position,line_color,line_geometry,line_material,line_mesh,laser_position,laser_color,laser_geometry,laser_material,laser_mesh,numLaser=20,ballGroup,gui,information=!0,popCloud=!1,runningCamera=!1,SHADOW_MAP_WIDTH=2048,SHADOW_MAP_HEIGHT=1024,cameraControls={fov:65,near:1,far:5e3,zoom:2,rotateSpeed:.001,x:0,y:0,z:500,actionFov:80,actionTarget:3},soundChannel={vocal:{position:25,max:30,min:20,value:100},bass:{position:4,max:10,min:0,threshold:98},high:{position:30,max:FFT_SIZE,min:.3*FFT_SIZE,threshold:60},low:{position:5,max:10,min:0,value:100},full:{position:4,max:100,min:0,threshold:95}},sound_group;initGUI(),init(),render(),window.addEventListener("keyup",dealWithKeyboard,!1),document.addEventListener("click",debug,!1);