function soundInit(){console.log("sound in init");try{audioContext=new(window.AudioContext||window.webkitAudioContext),loadFile()}catch(e){alert("you need webaudio support"+e)}}function loadFile(){var e=new XMLHttpRequest;e.open("GET","sounds/day.mp3",!0),e.responseType="arraybuffer",e.onload=function(){audioContext.decodeAudioData(e.response,function(e){buf=e,initBuffer()})},e.send()}function initBuffer(){var e=audioContext.createBufferSource();e.buffer=buf,fft=audioContext.createAnalyser(),fft.smoothingTimeConstant=.3,fft.fftSize=samples,e.connect(fft),fft.connect(audioContext.destination),e.start(0),setup=!0}function soundUpdate(){var e=new Uint8Array(samples);fft.getByteFrequencyData(e),console.log(e)}function FileLoader(){this.fileList=[],this.content={},this.totalBar=!1,this.indivisualBar=!1,this.totalBar=document.getElementById("progressBar"),this.indivisualBar=document.getElementById("progressBar-indivisual")}function KVec3(e,t){this.rangeMin=Math.PI/4*Math.random(),this.rangeMax=Math.PI/3*Math.random()*2+Math.PI/3,this.velocity=.02*(Math.random()-.5),this.velocity<=0?this.velocity-.01:this.velocity+.01,this.numConnected=0,this.radius=this.originalRadius=e,this.theta=Math.random()*Math.PI*2,this.phi=Math.random()*(this.rangeMax-this.rangeMin)+this.rangeMin,this.SEED=Math.random()-.5,this.ID=t,this.FIELD=10+20*Math.random(),this.onFFT=!1;var i,n,o;i=this.radius*Math.sin(this.phi)*Math.cos(this.theta),n=this.radius*Math.cos(this.phi),o=this.radius*Math.sin(this.phi)*Math.sin(this.theta),THREE.Vector3.call(this,i,n,o)}function map_range(e,t,i,n,o){return n+(o-n)*(e-t)/(i-t)}function initGUI(){gui=new dat.GUI({autoPlace:!1});var e=document.getElementById("my-gui-container");e.appendChild(gui.domElement);var t=gui.addFolder("Vocal");t.add(soundChannel.vocal,"position",0,FFT_SIZE),t.add(soundChannel.vocal,"min",0,150).name("Max Value"),t.add(soundChannel.vocal,"max",151,255).name("Min Value"),t.add(soundChannel.vocal,"value",0,255);var i=gui.addFolder("Bass");i.add(soundChannel.bass,"position",0,FFT_SIZE),i.add(soundChannel.bass,"min",0,150),i.add(soundChannel.bass,"max",151,255),i.add(soundChannel.bass,"value",0,255);var n=gui.addFolder("High");n.add(soundChannel.high,"position",0,FFT_SIZE),n.add(soundChannel.high,"min",0,150),n.add(soundChannel.high,"max",151,255),n.add(soundChannel.high,"value",0,255);var o=gui.addFolder("Low");o.add(soundChannel.low,"position",0,FFT_SIZE),o.add(soundChannel.low,"min",0,150),o.add(soundChannel.low,"max",151,255),o.add(soundChannel.low,"value",0,255);var a=gui.addFolder("Camera");a.add(cameraControls,"fov",30,120).name("FOV"),a.add(cameraControls,"zoom",2,5).name("Zoom"),a.add(cameraControls,"near",1,50).name("Near"),a.add(cameraControls,"far",500,3e3).name("Far"),a.add(cameraControls,"rotateSpeed",0,.1).name("Rotation"),a.open(),console.log("GUI initialized")}function init(){scene=new THREE.Scene,actionCam=new THREE.PerspectiveCamera(150,window.innerWidth/window.innerHeight,1e-4,500),actionCam.position.set(0,0,0),cameraHelper=new THREE.CameraHelper(actionCam),camera=new THREE.PerspectiveCamera(cameraControls.fov,window.innerWidth/window.innerHeight,cameraControls.near,cameraControls.far),camera.position.set(cameraControls.x,cameraControls.y,cameraControls.z),light=new THREE.SpotLight(16777215,.3),light.position.copy(camera.position),light.target.position.set(0,0,0),light.castShadow=!0,scene.add(light),hsLight=new THREE.HemisphereLight(16777215,526368,1),scene.add(hsLight);var e=new THREE.DodecahedronGeometry(.33*particles_radius,0),t=new THREE.MeshPhongMaterial({color:16723759,shading:THREE.FlatShading,shininess:0});core=new THREE.Mesh(e,t),scene.add(core);var i=new THREE.IcosahedronGeometry(.97*particles_radius,1),t=new THREE.MeshPhongMaterial({color:16777215,transparent:!0,opacity:.9,shading:THREE.FlatShading,shininess:0});earth=new THREE.Mesh(i,t),earth.receiveShadow=!0,earth.castShadow=!0,scene.add(earth);var n=FFT_SIZE,o=2*Math.PI;particles_geo=new THREE.BufferGeometry;var a=new Float32Array(3*n),s=new Float32Array(3*n),r=new Float32Array(n);particle_positions=[];for(var d=0;n>d;d++){var l=new KVec3(particles_radius,d);l.toArray(a,3*d),particle_positions.push(l);var c=new THREE.Color;d%15==0?c.setHSL(.9,.1,.3):c.setHSL(.01+.1*(d/n),1,.5),c.toArray(s,3*d),r[d]=100}particles_geo.addAttribute("position",new THREE.BufferAttribute(a,3)),particles_geo.addAttribute("aColor",new THREE.BufferAttribute(s,3)),particles_geo.addAttribute("size",new THREE.BufferAttribute(r,1)),line_position=new Float32Array(FFT_SIZE*FFT_SIZE*3),line_color=new Float32Array(FFT_SIZE*FFT_SIZE*3),line_geometry=new THREE.BufferGeometry,line_geometry.addAttribute("position",new THREE.BufferAttribute(line_position,3).setDynamic(!0)),line_geometry.addAttribute("color",new THREE.BufferAttribute(line_color,3).setDynamic(!0));var u=new THREE.PointsMaterial({color:0,size:0});particle=new THREE.Points(particles_geo,u),core.add(particle),line_material=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,blending:THREE.SubtractiveBlending,transparent:!0}),line_mesh=new THREE.LineSegments(line_geometry,line_material),line_mesh.geometry.setDrawRange(0,0),core.add(line_mesh);var h=document.createElement("div");h.style.position="absolute",h.style.top="10px",h.style.width="100%",h.style.textAlign="center",h.style.color="#fff",h.style.link="#f80",h.innerHTML='<a href="http://threejs.org" target="_blank">three.js</a> kent&rsquo;s test',document.body.appendChild(h),renderer=new THREE.WebGLRenderer({antialias:!0}),renderer.setClearColor(14540253),renderer.autoClear=!0,renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),renderer.domElement.id="canvas",document.body.appendChild(renderer.domElement),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.gammaInput=!0,renderer.gammaOutput=!0,stats=new Stats,stats.domElement.style.position="absolute",stats.domElement.style.top="0px",stats.domElement.style.right="0px",h.appendChild(stats.domElement),controls=new THREE.TrackballControls(camera,renderer.domElement),controls.minDistance=200,controls.maxDistance=500,dummy=new THREE.Vector3(1,1,1),dummy.x=particle_positions[3].x,dummy.y=particle_positions[3].y,dummy.z=particle_positions[3].z,ballGroup=new THREE.Object3D;for(var p=new THREE.SphereBufferGeometry(1,25,25),m=new THREE.MeshPhongMaterial({color:263172,shininess:2,specular:16777215}),f=new THREE.Mesh(p,m),d=0;FFT_SIZE>d;d++){var f=new THREE.Mesh(p,m);f.position.x=particle_positions[d].x,f.position.y=particle_positions[d].y,f.position.z=particle_positions[d].z,f.castShadow=!0,f.receiveShadow=!0,ballGroup.add(f)}particle.add(ballGroup),window.addEventListener("resize",onWindowResize,!1)}function all_rotation(e){earth.rotation.y+=3*e,earth.rotation.x+=3*e,earth.rotation.z-=3*e,particle.rotation.y+=e,particle.rotation.x+=e,line_mesh.rotation.y+=e,line_mesh.rotation.x+=e,core.rotation.y-=2*e,core.rotation.x+=3*e}function render(){all_rotation(cameraControls.rotateSpeed),checkZoom(),updateGUI(),sc.isPlaying&&(updateFFT(),parseFFT()),updatePosition(),checkDistance(),updateBalls(),updateDummy(particle_positions[3]),controls.update(),stats.update(),light.position.copy(camera.position),light.position.y+=100,light.position.x+=50,runningCamera?renderer.render(scene,actionCam):renderer.render(scene,camera),requestAnimationFrame(render)}function updateFFT(){sc.updateFFT(),fftList=[],fftList=sc.fft;for(i in fftList){var e=fftList[i];fftList[i]=map_range(e,0,255,0,100)}}function updateDummy(e){e.distanceTo(dummy)>2*e.FIELD&&dummy.lerp(e,.01),actionCam.position.set(dummy.x,dummy.y,dummy.z),actionCam.lookAt(e),actionCam.updateProjectionMatrix()}function updateBalls(){for(var e=ballGroup.children,t=0;t<e.length;t++){var i=e[t],n=particle_positions[t];i.position.set(n.x,n.y,n.z);var o=fftList[t],a=i.scale.x,s=90;a+=o>=s?.1*(o/3-a):.1*(1-a),i.scale.set(a,a,a)}}function updateGUI(){for(var e in gui.__folders){var t=gui.__folders[e];for(var i in t.__controllers)t.__controllers[i].updateDisplay()}fftList&&(soundChannel.vocal.value=fftList[Math.floor(soundChannel.vocal.position)]),camera.fov=cameraControls.fov,camera.near=cameraControls.near,camera.far=cameraControls.far,camera.updateProjectionMatrix()}function updateFakeFFT(){for(var e=Date.now(),t=0;t<fakeFFT.length;t++){var i=noise.simplex2(t,e);fakeFFT[t]=i/2}fakeFFT.reverse()}function parseFFT(){for(var e=0;e<fftList.length;e++);}function checkZoom(){}function checkDistance(){for(var e,t,i=40,n=3,o=0,a=0,s=0,r=0;FFT_SIZE>r;r++)particle_positions[r].numConnected=0;for(var d=0;FFT_SIZE>d;d++)if(e=particle_positions[d],!(e.numConnected>=n))for(var l=d+1;FFT_SIZE>l;l++){t=particle_positions[l];var c=e.x-t.x,u=e.y-t.y,h=e.z-t.z,p=Math.sqrt(c*c+u*u+h*h);if(!(t.numConnected>=n)&&i>p){e.numConnected++,t.numConnected++,line_position[o++]=e.x,line_position[o++]=e.y,line_position[o++]=e.z,line_position[o++]=t.x,line_position[o++]=t.y,line_position[o++]=t.z;var m=1-p/i;line_color[a++]=m,line_color[a++]=m,line_color[a++]=m,line_color[a++]=m,line_color[a++]=m,line_color[a++]=m,s++}}line_mesh.geometry.setDrawRange(0,2*s),line_mesh.geometry.attributes.position.needsUpdate=!0,line_mesh.geometry.attributes.color.needsUpdate=!0}function updatePosition(){for(var e=soundChannel.vocal.value,t=soundChannel.bass.value,i=particle_positions.length/nFFTBands,n=0;i>n;n++){var o=Math.floor(Math.random()*particle_positions.length);particle_positions[o].FFTin(e)}var a=particle.geometry.attributes;for(p in particle_positions){particle_positions[p].movePos();var r,d;r=particle_positions[p];for(s in particle_positions)d=particle_positions[s],r.ID!=d.ID&&r.pushPos(d);a.position.array[3*p]=particle_positions[p].x,a.position.array[3*p+1]=particle_positions[p].y,a.position.array[3*p+2]=particle_positions[p].z,255===fftList[p]&&popCloud===!0&&_createBox(particle_positions[p].x,particle_positions[p].y,particle_positions[p].z)}a.position.needsUpdate=!0}function _createBox(e,t,i){var n=10,o=new THREE.BoxGeometry(n,n,n);o.translate(e,t,i);var a=new THREE.MeshDepthMaterial({wireframe:!1}),s=new THREE.Mesh(o,a);scene.add(s)}function updateAudioData(){}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,actionCam.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),actionCam.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)}function dealWithKeyboard(e){switch(console.log(e.keyCode),e.keyCode){case 73:console.log("key I pressed"),information=!information;break;case 32:runningCamera=!runningCamera,console.log("switch camera: "+runningCamera);break;case 219:sc.fastBackward(1);break;case 221:sc.fastForward(1);break;case 220:sc.resetPlaybackRate();break;default:console.log("no key action taken, pressed: "+e.keyCode)}information?(gui.domElement.hidden=!1,stats.domElement.hidden=!1,document.getElementById("progressBar").style.display="block",document.getElementById("progressBar-indivisual").style.display="block"):(gui.domElement.hidden=!0,stats.domElement.hidden=!0,document.getElementById("progressBar").style.display="none",document.getElementById("progressBar-indivisual").style.display="none")}function testClick(){console.log("Document Clicked")}function debug(){}function updateShader(){var e=.01*Date.now()}var audioContext,buf,fft,samples=512,setup=!1;window.addEventListener("load",soundInit,!1);var SoundObject=function(e){console.log("creating Sound Object Class"),this.isPlaying=!1,this.isReady=!1,this.debugMode=!1,this.time="no available value";var t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;t?(this.context=new t,console.log("here is our context")):console.log("there is an issue with creating Audio Context"),this.sourceBuffer=this.context.createBufferSource(),this.analyser=this.context.createAnalyser(),this.analyser.smoothingTimeConstant=.3,this.analyser.fftSize=e,this.bufferLength=this.analyser.frequencyBinCount,this.fft=new Uint8Array(this.bufferLength),this.debugMode&&console.log(this.fft),this.loadedPercentage=0,this.fileIsReady=!1};SoundObject.prototype.init=function(e){console.log("Class initiated: "),this._decodeAudioData(e),e.time?this.time=e.time:console.log("no time available"),this.isReady=!0,this.sourceBuffer.loop=!0},SoundObject.prototype.play=function(){this.debugMode&&console.log("play the sound"),"suspended"!=this.context.state?this.sourceBuffer.start(0):this.context.resume(),this.isPlaying=!0},SoundObject.prototype.pause=function(){this.debugMode&&console.log("pause the sound"),this.context.suspend(),this.isPlaying=!1},SoundObject.prototype.updateFFT=function(){this.analyser.getByteFrequencyData(this.fft),this.debugMode&&console.log("updateFFT: "+this.fft)},SoundObject.prototype._decodeAudioData=function(e){e.parent=this,this.context.decodeAudioData(e,function(t){e.parent.analyser.getByteTimeDomainData(e.parent.fft),e.parent.sourceBuffer.buffer=t,e.parent.sourceBuffer.connect(e.parent.analyser),e.parent.analyser.connect(e.parent.context.destination)})},SoundObject.prototype.fastForward=function(e){this.sourceBuffer.playbackRate.value+=e},SoundObject.prototype.fastBackward=function(e){this.sourceBuffer.playbackRate.value-=e},SoundObject.prototype.resetPlaybackRate=function(){this.sourceBuffer.playbackRate.value=1},FileLoader.prototype.start=function(e){this.fileList=e;var t=this.fileList,i=this.content;console.log(this.fileList);var n=function(e){console.log("load started")},o=function(e){var t=e.loaded/e.total*100;this.indivisualBar.value=t,console.log(e.loaded+" / "+e.total+" / "+e.target.fileID)},a=function(e){r++;var n=r/s*100;this.totalBar.value=n,console.log("log finished"),i[e.target.fileID]=e.target.response,i[e.target.fileID].time=e.target.time,r===t.length&&document.dispatchEvent(allFilesLoaded)},s=this.fileList.length,r=0,d=0;for(object in this.fileList){var l=new XMLHttpRequest;l.open("GET",this.fileList[object].path,!0),l.responseType=this.fileList[object].type,l.time=this.fileList[object].time,l.fileID=this.fileList[object].name,l.totalBar=this.totalBar,l.indivisualBar=this.indivisualBar,l.addEventListener("loadstart",n,!0),l.addEventListener("progress",o,!0),l.addEventListener("loadend",a,!0),l.send()}},KVec3.prototype=THREE.Vector3.prototype,KVec3.prototype.FFTin=function(e){var t=this.originalRadius+e;e>=200?(this.radius-=(t-this.radius)/5,this.onFFT=!0):this.onFFT=!1},KVec3.prototype.getPosition=function(){var e=THREE.Vector3(this._x,this._y,this._z);return e},KVec3.prototype.movePos=function(){this.phi<this.rangeMin||this.phi>this.rangeMax?this.SEED*=-1:this.SEED+=(Math.random()-.5)/10,this.phi+=this.SEED/1e3,this.theta+=this.velocity/2;var e=new THREE.Vector3;e.x=this.radius*Math.sin(this.phi)*Math.cos(this.theta),e.y=this.radius*Math.cos(this.phi),e.z=this.radius*Math.sin(this.phi)*Math.sin(this.theta);var t=e.sub(this);this.add(t)},KVec3.prototype.pushPos=function(e){var t=this.distanceTo(e);if(t<=this.FIELD){this.phi+=this.velocity*this.SEED,this.theta+=this.velocity*(Math.random()-.5);var i=new THREE.Vector3(this.x,this.y,this.z);i.sub(e),i.normalize(),this.sub(i)}},KVec3.prototype.randomUpdate=function(){console.log("the theta is : "+this.theta+"/ this x y z: "+this.x+"/"+this.y+"/"+this.z)};var sc=new SoundObject(1024),fileLoader=new FileLoader,files=[{name:"music",path:"sounds/day.mp3",type:"arraybuffer",time:400}];fileLoader.start(files);var allFilesLoaded=new Event("fire");document.addEventListener("fire",function(e){console.log("FIRRRRRRRRRRE!!!!!!"),document.getElementById("audio-play").classList.add("avl"),sc.init(fileLoader.content.music)}),document.getElementById("audio-play").addEventListener("click",function(){sc.play()}),document.getElementById("audio-pause").addEventListener("click",function(){sc.pause()});var camera,actionCam,scene,renderer,controls,stats,fftList,light,hsLight,cameraHelper,core,earth,dummy,FFT_SIZE=256,fftList=new Array(FFT_SIZE),particle,particles_geo,particle_met,pt_uniforms,particles_radius=250,fftBands=[],nFFTBands=5,particle_positions,fakeFFT,line_position,line_color,line_geometry,line_material,line_mesh,ballGroup,gui,information=!0,popCloud=!1,runningCamera=!1,SHADOW_MAP_WIDTH=2048,SHADOW_MAP_HEIGHT=1024,cameraControls={fov:65,near:1,far:1e3,zoom:2,rotateSpeed:.001,x:0,y:0,z:500},soundChannel={vocal:{position:0,max:255,min:0,value:100},bass:{position:20,max:255,min:0,value:100},high:{position:40,max:255,min:0,value:100},low:{position:60,max:255,min:0,value:100}},sound_group;initGUI(),init(),render(),window.addEventListener("keyup",dealWithKeyboard,!1),document.addEventListener("click",debug,!1);